# ドメイン設計書

## エンティティ

| エンティティ | 説明 | 主な属性（プロパティ） |
|------------|------|---------------------|
| Account | ログインしているユーザー。ノートやテンプレートの作成者 | id, email, firstName, lastName, isActive, provider, providerAccountId, thumbnail, lastLoginAt, createdAt, updatedAt |
| Template | ノートのフォーマット。入力欄（Field）を定義する | id, name, ownerId, fields[], updatedAt |
| Field | テンプレート内の1つの入力欄 | id, label, order, isRequired |
| Note | 設計メモ1件。テンプレートを使って書かれる | id, title, templateId, ownerId, status, sections[], createdAt, updatedAt |
| Section | ノート内の1つの欄（Fieldに対応） | id, fieldId, content |
| Status | ノートの状態。下書き（Draft）か公開（Publish） | draft, publish |

## VO（Value Object）

| 名前 | 使う場所 | 守るルール（ほんの少しの約束） | 例 | 備考 |
|-----|---------|--------------------------|-----|------|
| Email | Account.email | 「@」が必ずある／空NG／前後の空白トリム | user@example.com | みんなで同じルール、間違うと困るのでVOにする |
| Status | Note.status | Draft または Publish だけOK | Draft / Publish | アプリの意味が強い（公開/下書き）のでVOにする |

## 集約

| **🏷️ チーム名（集約）** | **👑 集約ルート（リーダー）** | **👥 中にいるメンバー（子エンティティ・VO）** | **🔗 外との関係・使い方** | **💬 チームの役割（ざっくり）** |
|-------------------|------------------------|-----------------------------------|---------------------|---------------------------|
| 🟦 **Noteチーム** | **Note** | - Section（本文の各パート）<br>- Status（状態） | - Templateを参照（どの型で書くか）<br>- Accountに属する（Owner） | テンプレを使って1件のノートを作るチーム。Noteがリーダーで、Sectionは中身 |
| 🟩 **Templateチーム** | **Template** | - Field（入力欄の定義） | - Accountに属する（Owner）<br>- Noteから利用される | ノートの型（構造）を定義するチーム。Templateがリーダーで、Fieldがその中のパーツ |
| 🟨 **Accountチーム** | **Account** | - Email（VO）<br>- プロバイダー情報（provider, providerAccountId） | - Note／Templateを所有する | OAuthでログインしたユーザーを表すチーム。他チームの親（所有者） |
| ⚪ **共通VO**（どのチームにも属さない小さな部品） | なし（単独） | - Email（Account用）<br>- Status（Note用） | 各チームで使われる共通ルール | |

### 🧩 関係図で見るとこんな感じ

```
[Account]──owns──>[Template]──contains──>[Field]
     │
     └──owns──>[Note]──contains──>[Section]
                       │
                       └──uses──>[Template]
```

## ドメインロジック

### 🟦 Noteチーム（ノートの世界）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| ノートを作るときはテンプレートが必要 | ノートが「テンプレートがないと書けない」と決めている |
| ノートを作るときはセクションが必須 | テンプレートの全フィールドに対応するセクションを渡す必要がある |
| 必須フィールドのセクションは内容が必要 | isRequired=trueのフィールドに対応するセクションはcontentが空だとエラー |
| ノートを消したら中のセクションも一緒に消す | ノートが親分で、セクションはその子。親が消えたら子も一緒に消える |
| ステータスは「下書き」か「公開」だけ | ほかの言葉（例：プレビュー）は使えない。2つの状態しか持たない |
| ステータスを変えられるのはオーナーだけ（判定だけ） | 誰が変えられるかをノートの中で判断する。「自分のノートだけOK」 |

### 🟩 Templateチーム（テンプレートの世界）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| Field（項目）の順番はかぶらない | テンプレートの中で、1番・2番・3番が重ならないように並べる |
| Field（項目）の名前は空じゃダメ | 「問題」「決定」など、欄の名前がないと使えないから |
| Fieldの追加・削除・並べ替えはテンプレートがまとめて行う | 子どものFieldを勝手に触れないように、親のテンプレートが管理する |

### 🟨 Accountチーム（アカウントの世界）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| 少なくとも名前（firstName）か苗字（lastName）のどちらかは必須 | 誰かわからないから、最低でも名前か苗字のどちらかは必要 |
| provider + providerAccountIdの組み合わせは一意 | 同じOAuthプロバイダーで同じアカウントIDは1つだけ |
| アカウントは自分のノートとテンプレートを"持つ" | 自分のものだけを見たり直したりできるように関係を持っている |
| ログイン時にプロフィール情報と最終ログイン時刻を更新 | OAuthログイン時に最新のプロフィール情報で更新する |

### ⚪ 共通ルール（どのチームでも同じ）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| 子ども（SectionやField）は、親（NoteやTemplate）を通してしか触れない | 外から直接いじれないように、親がまとめて面倒を見る |
| チームの中のモノは、チームごとに保存・変更する | 別のチームのデータを勝手に直さないようにしている |

## ドメインサービス

| **🧩 サービス名** | **💬 どんな仕事？** | **🏗️ 関わるドメイン（集約）** |
|----------------|-----------------|------------------------|
| canPublish | ノートを「下書き→公開」にしていいかを判定する。オーナーならOK、他人ならNGという条件をチェックする係 | Note ＋ Account |
| canUnpublish | ノートの公開を取り消せるかを判定する。オーナーならOK、他人ならNGという条件をチェックする係 | Note ＋ Account |

## 集約境界とトランザクション境界

### 集約とトランザクションの関係

このシステムでは、**集約（Aggregate）の境界 = トランザクション境界**とします。

| 集約 | トランザクション対象 | 理由 |
|------|-------------------|------|
| Template | template + fields | テンプレートと項目は一体で管理。片方だけ更新されると不整合が発生 |
| Note | note + sections | ノートと各セクションは一体で管理。片方だけ更新されると不整合が発生 |
| Account | account のみ | 単一エンティティで完結。他のエンティティとの同時更新は不要 |

### トランザクションが必要な操作

以下の操作ではトランザクションが必要です：

1. **集約の作成**
   - Template作成: template + fields を同時作成
   - Note作成: note + sections を同時作成

2. **集約の更新**
   - Template更新: 存在確認 + template + fields の更新
   - Note更新: 存在確認 + note + sections の更新

3. **集約の削除**
   - Template削除: 使用チェック + template + fields の削除
   - Note削除: 存在確認 + note + sections の削除

4. **状態変更**
   - Note公開/非公開: 権限チェック + note + sections の更新

### トランザクション不要な操作

以下の操作ではトランザクションは不要です：

1. **読み取り専用のクエリ**
   - Template一覧取得
   - Note一覧取得
   - Account取得

2. **単一エンティティの操作**
   - Accountのプロフィール更新（単一テーブルの更新）