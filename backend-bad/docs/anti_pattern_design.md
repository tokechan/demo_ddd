# Lesson 1: アンチパターン API の地図

この Go バックエンドは「見た目は普通だけど中身は悲惨」な状態をわざと再現しています。API 契約は TypeSpec で固めているのに、内部は責務も境界もごちゃ混ぜ。ここではまず地図を広げて、「どんな地雷が埋まっているか」「どこを観察すれば痛みが分かるか」を把握します。

> 📘 **学習ルート**
> 1. このファイルで全体像とアンチパターンの一覧を把握する
> 2. `anti_pattern_walkthrough.md` で具体的なコード例を確認する
> 3. `anti_pattern_fix.md` で改善のアイデアを読む

---

## 1. プロジェクトの前提

- **外側はちゃんとしている** … エンドポイントと DTO は TypeSpec で定義済み。Next.js フロントから叩けば普通に動きます。
- **内側は崩壊寸前** … Echo + sqlc + golang-migrate を使いながら、Controller・Service・DB の境界がすべて曖昧になるように設計。
- **教材の狙い** …「なぜ設計を分離しないといけないのか」を体験で理解すること。後でクリーンアーキ版と比較できるように、あえて泥沼を残しています。

使用技術まとめ:
- Echo（Web フレームワーク）
- sqlc（SQL → Go コード生成）
- golang-migrate（DB マイグレーション）

---

## 2. 仕込まれているアンチパターン

| # | 何をやらかしているか | どう困るのか |
|---|-----------------------|--------------|
| 1 | ドメイン層がなく、TypeSpec の型と sqlc の型を Service で直に扱う | API/DB の小さな変更でも全層を書き換える羽目になる。ビジネスルールの居場所がない |
| 2 | Controller をルーター代わりにし、Service に全部押し付ける | バリデーション・ログ・DB 詰め替えが 1 関数に詰まり、巨大関数化 |
| 3 | Repository interface を作らず sqlc を直呼び | DB を差し替えたりモックしたりできず、テスト不能 |
| 4 | ユースケース単位のメソッドがなく、if/switch で分岐しまくる | 条件が増えるたびに if が爆発し、仕様が追えない |
| 5 | ビジネスルールがファイル全体に点在 | 「制約はどこ？」を知るには全文検索するしかない |
| 6 | トランザクションを各 Service が手書き | Begin/Commit/Rollback のコピペ地獄。書き忘れが発生しやすい |
| 7 | エラー JSON だけ統一して中身は雑 | クライアントから原因を特定できない。意味のあるエラーハンドリングができない |
| 8 | Config や Logger を直接参照 | 依存が散らばり、テストも差し替えも大変 |
| 9 | TypeSpec のインターフェースを真面目に実装していない | 未実装のエンドポイントに気づけず放置される |

👉 この一覧は `anti_pattern_walkthrough.md` で実際のファイルと紐付けて掘り下げます。

---

## 3. ディレクトリの見取り図

```
backend/
├─ cmd/api/main.go          # Echo を起動するエントリーポイント
├─ internal/
│  ├─ controller/           # ルーティング＋レスポンス（肥大化した層）
│  ├─ service/              # すべてを抱える神オブジェクト層
│  ├─ db/                   # sqlc の生成物や接続関連
│  └─ generated/            # TypeSpec / sqlc が吐いたコード
└─ migrations/              # golang-migrate 用 SQL
```

> 🔧 **ワーク**: VS Code で `internal/controller/template_controller.go` を開き、1 メソッドの行数と責務をメモってみる。`internal/service/template_service.go` も同様に眺め、どの層の仕事が混ざっているか洗い出してみましょう。

---

## 4. 学習のルール

1. **API 契約は崩さない** … TypeSpec で決めた入出力は守ったまま、内部だけを泥沼にする。
2. **あえて崩して観察する** … Controller / Service / DB の境界を意図的に曖昧にし、テストや保守がどれだけ辛くなるかを体感する。
3. **後から改善できるよう記録を残す** … 気づいた痛みは `anti_pattern_fix.md` を読む前にメモしておくと、改善案と比べやすいです。

---

## 5. 次のアクション

- `anti_pattern_walkthrough.md` でコードと照らし合わせながらアンチパターンを観察
- `anti_pattern_fix.md` で「じゃあどう直すか？」のガイドを見る
- `migrations.md` で DB セットアップ手順を確認し、実際に API を叩いて挙動を確かめる

このファイルで地図が頭に入ったら、さっそく Walkthrough に進んで現場の“痛み”を感じてみましょう。EOF
